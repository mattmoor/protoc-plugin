
apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: pingservice-pingstream
spec:
  runLatest:
    configuration:
      revisionTemplate:
        spec:
          serviceAccountName: default
          containerConcurrency: 2
          container:
            image: docker.io/mattmoor/grpc-ping-go
            ports:
            - name: h2c
              containerPort: 8080
            env:

            - name: FOO
              value: BAZ

---

apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: pingservice-ping
spec:
  runLatest:
    configuration:
      revisionTemplate:
        spec:
          serviceAccountName: default
          containerConcurrency: 20
          container:
            image: docker.io/mattmoor/grpc-ping-go
            ports:
            - name: h2c
              containerPort: 8080
            env:

            - name: FOO
              value: BAR

---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: grpc-gateway
spec:
  gateways:
  - knative-ingress-gateway.knative-serving.svc.cluster.local
  - mesh
  hosts:
  - mattmoor.io
  http:

  - match:
    - uri:
        exact: /ping.PingService/Ping
    rewrite:
      authority: pingservice-ping.default.svc.cluster.local
    route:
      - destination:
          host: istio-ingressgateway.istio-system.svc.cluster.local
          port:
            number: 80
        weight: 100

  - match:
    - uri:
        exact: /ping.PingService/PingStream
    rewrite:
      authority: pingservice-pingstream.default.svc.cluster.local
    route:
      - destination:
          host: istio-ingressgateway.istio-system.svc.cluster.local
          port:
            number: 80
        weight: 100
